<!DOCTYPE html>
<html>

<head>
  <title>TWR Email Signature Tool</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous" />
  <link rel="stylesheet" href="css/style.css" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="js/config.js"></script>
  <script>
    let windowUrl = new URL(window.location.href);
    let GAPI_ACTION = 'load';
    const CLIENT_ID = config.CLIENT_ID;
    const API_KEY = config.API_KEY;
    window.onload = function () {
      const signInWithBtn = window.signInWithBtn = document.getElementById("g-siw_btn");
      const signOutBtn = window.signOutBtn = document.getElementById('gacct-user-signout');

      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: true,
        cancel_on_tap_outside: false,
      });

      google.accounts.id.renderButton(
        document.getElementById("g-siw_btn"),
        { theme: "outline", size: "large" }  // customization attributes
      );
      google.accounts.id.prompt((notification) => {
        console.log(notification)
      }); // also display the One Tap dialog

      handleAuth();

      // handle consent for gmail api
      window.client = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/gmail.settings.basic \
              https://www.googleapis.com/auth/gmail.settings.sharing \
              https://www.googleapis.com/auth/userinfo.profile \
              https://www.googleapis.com/auth/user.organization.read \
              https://www.googleapis.com/auth/user.gender.read \
              https://www.googleapis.com/auth/user.phonenumbers.read',
        callback: (tokenResponse) => {
          if (tokenResponse && tokenResponse.access_token) {
            gapi.client.setApiKey(API_KEY);

            // load
            gapi.client.load('gmail', 'v1', () => {
              const GAPI_ACTION_CONTROl_OBJ = {
                'load': getGmailSignature,
                'set': patchGmailSendAs
              }
              GAPI_ACTION_CONTROl_OBJ[GAPI_ACTION]()
            });

            gapi.client.load('people', 'v1', () => {
              // const GAPI_ACTION_CONTROl_OBJ = {
              //   'load': getGmailSignature,
              //   'set': patchGmailSendAs
              // }
              // GAPI_ACTION_CONTROl_OBJ[GAPI_ACTION]()
              getProfileDetails();

            });
          }
        }
      });
      signOutBtn.addEventListener('click', handleSignout);
    }
  </script>
  <script src="https://unpkg.com/vue@3"></script>
</head>

<body>
  <div id="app">
    <header>
      <nav class="app__navbar navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Email Signature (<small>Beta 1.7.0</small>)</a>
          <ul class="navbar-nav me-auto mb-lg-0">
            <li class="nav-item">
              <div id="g-siw_btn"></div>
            </li>
            <li class="nav-item">
              <span id="gacct-user" class="navbar-text"></span>
            </li>
          </ul>

          <ul class="navbar-nav">
            <li class="nav-item"><a id="gacct-user-signout" href="#" class="nav-link" style="display: none;"></a></li>
          </ul>
        </div>
      </nav>
    </header>
    <main class="app__content">
      <div class="app__modal app__modal--share fade" :class="{'show modal-active': modelIsOpen }">
        <div class="modal__bg" @click="triggerModal"></div>
        <div class="modal__container">
          <div class="modal__header">
            <h1 class="modal__heading">Share this signature</h1>
            <a class="modal__close" tabindex="0" role="button" @click="triggerModal">close</a>

          </div>
          <div class="modal__body">
            <div class="input-group">

              <input class="modal__input form-control" :value="shareURL" type="text" readonly aria-readonly="true">
              <a id="modal-ctc-btn" href="" @click="getShareURL" class="modal__btn modal__copy btn btn-dark"
                tabindex="1" role="button">Copy</a>
            </div>
          </div>
          <div class="modal__footer">

          </div>
        </div>

      </div>
      <div class="app__editor">
        <form>
          <legend>Signature Details</legend>

          <div class="mb-3">
            <label for="name" class="form-label">Name</label>
            <input @focus="handleFocus($event, personName)" type="text" class="form-control" id="name"
              aria-describedby="nameHelp" v-model="personName" />
            <!-- <div id="emailHelp" class="form-text">
            We'll never share your email with anyone else.
          </div> -->
          </div>
          <div class="mb-3">
            <!-- <TransitionGroup name="fade"> -->
            <label for="pronoun-0" class="form-label">Pronouns </label>
            <label class="m-2"><input class="form-check-input" type="checkbox" value="" id="disable-pronoun-chbx"
                v-model="disablePronouns" />
              Hide Pronoun(s)?</label>
            <div class="row mb-1" :class="{'d-none': disablePronouns }" v-for="(pronoun, index) in pronouns"
              :key="index">
              <div class="col-8">
                <input type="text" class="form-control" :id="'pronoun-' + index" aria-describedby="pronounHelp"
                  @focus="handleFocus($event, pronoun.text)" v-model="pronoun.text" />
              </div>
              <div class="d-flex col-4 p-0">
                <span class="btn btn-secondary btn-sm btn-dynamic" @click="insertPronoun(index)">+</span>
                <span class="btn btn-secondary btn-sm btn-dynamic" @click="removePronoun(pronoun.id)"
                  v-if="pronouns.length > 1">-</span>
              </div>
            </div>
            <!-- </TransitionGroup> -->
            <!-- <div id="emailHelp" class="form-text">
            We'll never share your email with anyone else.
          </div> -->
          </div>
          <div class="mb-3">
            <label for="job-title" class="form-label">Job Title</label>
            <input @focus="handleFocus($event, jobTitle)" type="text" class="form-control" id="job-title"
              aria-describedby="jobTitleHelp" v-model="jobTitle" />
            <!-- <div id="emailHelp" class="form-text">
            We'll never share your email with anyone else.
          </div> -->
          </div>
          <div class="mb-3">
            <label for="main-phone" class="form-label">Phone</label>
            <input @focus="handleFocus($event, mainPhoneNum)" @input="formatPhone()" type="tel" class="form-control"
              id="main-phone" aria-describedby="mainPhoneNumHelp" v-model="mainPhoneNum" />
            <!-- <div id="emailHelp" class="form-text">
            We'll never share your email with anyone else.
          </div> -->
          </div>
          <div class="mb-3">
            <label for="website" class="form-label">Website</label>
            <input @focus="handleFocus($event, website)" type="text" class="form-control" id="website"
              aria-describedby="websiteHelp" v-model="website" />
            <!-- <div id="emailHelp" class="form-text">
                      We'll never share your email with anyone else.
                    </div> -->
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input @focus="handleFocus($event, email)" type="email" class="form-control" id="email"
              aria-describedby="emailHelp" v-model="email" />
            <!-- <div id="emailHelp" class="form-text">
            We'll never share your email with anyone else.
          </div> -->
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Disclaimer</label>
            <label for="btn-disclaimer-none"><input class="form-check-input input--hidden" checked type="radio"
                name="disclaimerRadio" value="" id="btn-disclaimer-none" @click="insertDisclaimer($event, '')" /><span
                class=" btn-pill">None</span></label>
            <label for="btn-disclaimer-legal"><input class="form-check-input input--hidden" type="radio"
                name="disclaimerRadio" value="" id="btn-disclaimer-legal"
                @click="insertDisclaimer($event, legalDisclaimerText)" /><span class=" btn-pill">Legal</span></label>
            <label for="btn-disclaimer-responseTime"><input class="form-check-input input--hidden" type="radio"
                name="disclaimerRadio" value="" id="btn-disclaimer-responseTime"
                @click="insertDisclaimer($event, responseTimeDisclaimerText)" /><span class=" btn-pill">Response
                Time</span></label>
            <textarea @focus="handleFocus($event, disclaimer)" rows="4" class="form-control" id="disclaimer"
              aria-describedby="disclaimerHelp" v-model="disclaimer"></textarea>
            <!-- <div id="emailHelp" class="form-text">
                      We'll never share your email with anyone else.
                    </div> -->
          </div>
        </form>
      </div>
      <div class="app__preview">
        <div class="preview__heading">Signature Details Preview</div>
        <table class="main__html" style="direction: ltr; border-collapse: collapse">
          <tbody>
            <tr>
              <td>
                <table cellpadding="0" cellspacing="0" class="twr-tpl"
                  style="font-family: Arial; line-height: 1.15; color: #000">
                  <tbody>
                    <tr>
                      <td>
                        <table cellpadding="0" cellspacing="0" width="100%" style="width: 100%">
                          <tbody>
                            <tr>
                              <td valign="top" style="
                                    vertical-align: top;
                                    padding-bottom: 10px;
                                  ">
                                <table cellpadding="0" cellspacing="0" class="twr-tpl-photo" style="width: 65px">
                                  <tbody>
                                    <tr>
                                      <td>
                                        <a v-if="hasWebsite" :href="website">
                                          <img :src="orgLogo" height="52" width="180" style="
                                              width: 180;
                                              vertical-align: initial;
                                              border-radius: 4px;
                                              display: block;
                                              height: 52px;
                                            " />
                                        </a>
                                        <img v-if="!hasWebsite" :src="orgLogo" height="52" width="180"
                                          style=" width: 180; vertical-align: initial; border-radius: 4px; display: block; height: 52px;" />
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </td>
                    </tr>
                    <tr>
                      <td style="vertical-align: top" valign="top">
                        <table cellpadding="0" cellspacing="0" style="width: 100%">
                          <tbody>
                            <tr>
                              <td style="
                                    padding-bottom: 12px;
                                    line-height: 18px;
                                  ">
                                <span data-acs="name" class="twr-tpl-name" style="
                                      font-family: Arial;
                                      text-transform: initial;
                                      font-weight: bold;
                                    " v-if="hasName"><span style="color: #333; font-size: 16px">{{personName}}
                                  </span></span>
                                <span style="
                                      font-size: 12px;
                                      letter-spacing: 0px;
                                      font-family: Arial;
                                      text-transform: initial;
                                      font-weight: normal;
                                      color: #616263;
                                    " v-if="hasPronouns || (disablePronouns == false)">
                                  <em v-html="getPronouns(',')"></em></span><br
                                  v-if="hasName || hasPronouns && disablePronouns == false" />
                                <span data-acs="title" class="twr-tpl-title" style="
                                      font-size: 12px;
                                      letter-spacing: 0px;
                                      font-family: Arial;
                                      text-transform: initial;
                                      font-weight: bold;
                                      color: #333;
                                    " v-if="jobTitle.length != 0">
                                  {{jobTitle}}
                                </span>
                                <br v-if="jobTitle.length != 0" />
                                <span data-acs="company" class="twr-tpl-company" style="
                                      font-size: 12px;
                                      letter-spacing: 0px;
                                      font-family: Arial;
                                      text-transform: initial;
                                      font-weight: bold;
                                      color: #055ea4;
                                    ">
                                  {{orgName}}
                                </span>
                              </td>
                            </tr>
                            <tr>
                              <td style="line-height: 0">
                                <table cellpadding="0" cellspacing="0">
                                  <tbody>
                                    <tr>
                                      <td>
                                        <table cellpadding="0" cellspacing="0">
                                          <tbody>
                                            <tr>
                                              <td style="
                                                    line-height: 0%;
                                                    padding-bottom: 6px;
                                                  " v-if="mainPhoneNum.length != 0">
                                                <table class="twr-tpl-phone" cellpadding="0" cellspacing="0" style="
                                                      line-height: 14px;
                                                      font-size: 12px;
                                                      font-family: Arial;
                                                    ">
                                                  <tbody>
                                                    <tr>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-weight: bold;
                                                            font-size: 12px;
                                                            color: #45668e;
                                                          ">
                                                        <img
                                                          src="https://www.thewritingrevolution.org/img/email/v1/phone.png"
                                                          style="
                                                              vertical-align: -2px;
                                                              line-height: 1.2;
                                                            " />
                                                      </td>
                                                      <td style="
                                                            width: 5px;
                                                            font-size: 1pt;
                                                            line-height: 0;
                                                          " width="5">
                                                        &nbsp;
                                                      </td>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-size: 12px;
                                                          ">
                                                        <a :href="`tel:${mainPhoneNum}`" target="_blank" style="
                                                              color-scheme: light
                                                                only;
                                                              text-decoration: none;
                                                              font-size: 12px;
                                                              font-family: Arial;
                                                            ">
                                                          <span data-acs="phone" style="
                                                                line-height: 1.2;
                                                                color-scheme: light
                                                                  only;
                                                                color: #212121;
                                                                font-family: Arial;
                                                                white-space: nowrap;
                                                                font-size: 12px;
                                                              ">
                                                            {{mainPhoneNum}}
                                                          </span>
                                                        </a>
                                                      </td>
                                                    </tr>
                                                  </tbody>
                                                </table>
                                              </td>
                                              <td v-if="website.length != 0" style="
                                                    line-height: 0%;
                                                    padding-bottom: 6px;
                                                  ">
                                                <table class="twr-tpl-website" cellpadding="0" cellspacing="0" style="
                                                      line-height: 14px;
                                                      font-size: 12px;
                                                      font-family: Arial;
                                                    ">
                                                  <tbody>
                                                    <tr>
                                                      <td v-if="mainPhoneNum.length != 0" style="padding: 0 6px">
                                                        <span style="
                                                              color-scheme: light
                                                                only;
                                                              font-family: Arial;
                                                              font-weight: bold;
                                                              font-size: 12px;
                                                              color: #212121;
                                                            ">
                                                        </span>
                                                      </td>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-weight: bold;
                                                            font-size: 12px;
                                                            color: #45668e;
                                                          ">
                                                        <img
                                                          src="https://www.thewritingrevolution.org/img/email/v1/site.png"
                                                          style="
                                                              vertical-align: -2px;
                                                              line-height: 1.2;
                                                            " />
                                                      </td>
                                                      <td style="
                                                            width: 5px;
                                                            font-size: 1pt;
                                                            line-height: 0;
                                                          " width="5">
                                                        &nbsp;
                                                      </td>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-size: 12px;
                                                          ">
                                                        <a :href="website" target="_blank" style="
                                                              color-scheme: light
                                                                only;
                                                              text-decoration: none;
                                                              font-size: 12px;
                                                              font-family: Arial;
                                                            ">
                                                          <span data-acs="website" style="
                                                                line-height: 1.2;
                                                                color-scheme: light
                                                                  only;
                                                                color: #212121;
                                                                font-family: Arial;
                                                                white-space: nowrap;
                                                                font-size: 12px;
                                                              ">
                                                            {{getWebsiteHost}}
                                                          </span>
                                                        </a>
                                                      </td>
                                                    </tr>
                                                  </tbody>
                                                </table>
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </td>
                                    </tr>
                                    <tr v-if="email.length != 0">
                                      <td>
                                        <table cellpadding="0" cellspacing="0">
                                          <tbody>
                                            <tr>
                                              <td style="
                                                    line-height: 0%;
                                                    padding-bottom: 6px;
                                                  ">
                                                <table class="twr-tpl-email" cellpadding="0" cellspacing="0" style="
                                                      line-height: 14px;
                                                      font-size: 12px;
                                                      font-family: Arial;
                                                    ">
                                                  <tbody>
                                                    <tr>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-weight: bold;
                                                            font-size: 12px;
                                                            color: #45668e;
                                                          ">
                                                        <img
                                                          src="https://www.thewritingrevolution.org/img/email/v1/email.png"
                                                          style="
                                                              vertical-align: -2px;
                                                              line-height: 1.2;
                                                            " />
                                                      </td>
                                                      <td style="
                                                            width: 5px;
                                                            font-size: 1pt;
                                                            line-height: 0;
                                                          " width="5">
                                                        &nbsp;
                                                      </td>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-size: 12px;
                                                          ">
                                                        <a :href="`mailto:${email}`" target="_blank" style="
                                                              color-scheme: light
                                                                only;
                                                              text-decoration: none;
                                                              font-size: 12px;
                                                              font-family: Arial;
                                                            ">
                                                          <span data-acs="email" style="
                                                                line-height: 1.2;
                                                                color-scheme: light
                                                                  only;
                                                                color: #212121;
                                                                font-family: Arial;
                                                                white-space: nowrap;
                                                                font-size: 12px;
                                                              ">
                                                            {{email}}
                                                          </span>
                                                        </a>
                                                      </td>
                                                    </tr>
                                                  </tbody>
                                                </table>
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </td>
                                    </tr>
                                    <tr class="row__address">
                                      <td>
                                        <table cellpadding="0" cellspacing="0">
                                          <tbody>
                                            <tr>
                                              <td style="
                                                    line-height: 0%;
                                                    padding-bottom: 6px;
                                                  ">
                                                <table class="twr-tpl-address" cellpadding="0" cellspacing="0" style="
                                                      line-height: 14px;
                                                      font-size: 12px;
                                                      font-family: Arial;
                                                    ">
                                                  <tbody>
                                                    <tr>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-weight: bold;
                                                            font-size: 12px;
                                                            color: #45668e;
                                                          ">
                                                        <img
                                                          src="https://www.thewritingrevolution.org/img/email/v1/address.png"
                                                          style="
                                                              vertical-align: -2px;
                                                              line-height: 1.2;
                                                            " />
                                                      </td>
                                                      <td style="
                                                            width: 5px;
                                                            font-size: 1pt;
                                                            line-height: 0;
                                                          " width="5">
                                                        &nbsp;
                                                      </td>
                                                      <td style="
                                                            color-scheme: light
                                                              only;
                                                            font-family: Arial;
                                                            font-size: 12px;
                                                          ">
                                                        <a href="https://maps.google.com/?q=90 Broad Street, 3rd Floor, New York, NY 10004"
                                                          target="_blank" style="
                                                              color-scheme: light
                                                                only;
                                                              text-decoration: none;
                                                              font-size: 12px;
                                                              font-family: Arial;
                                                            ">
                                                          <span data-acs="address" style="
                                                                line-height: 1.2;
                                                                color-scheme: light
                                                                  only;
                                                                color: #212121;
                                                                font-family: Arial;
                                                                white-space: nowrap;
                                                                font-size: 12px;
                                                              ">
                                                            {{addrLine1}},
                                                            {{addrLine2}}
                                                            {{city}} {{state}}
                                                            {{zip}}
                                                          </span>
                                                        </a>
                                                      </td>
                                                    </tr>
                                                  </tbody>
                                                </table>
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                            <tr>
                              <td style="padding-top: 12px">
                                <table class="twr-tpl-social" cellpadding="0" cellspacing="0" style="width: 100%">
                                  <tbody>
                                    <tr>
                                      <td>
                                        <table border="0" cellpadding="0" cellspacing="0">
                                          <tbody>
                                            <tr>
                                              <td align="left" style="
                                                    padding-right: 6px;
                                                    text-align: center;
                                                    padding-top: 0;
                                                  ">
                                                <a href="https://www.facebook.com/TheWritingRevolution/"
                                                  target="_blank">
                                                  <img width="24" height="24"
                                                    src="https://www.thewritingrevolution.org/img/email/v1/social_fb.png"
                                                    style="
                                                        float: left;
                                                        border: none;
                                                      " border="0" />
                                                </a>
                                              </td>
                                              <td align="left" style="
                                                    padding-right: 6px;
                                                    text-align: center;
                                                    padding-top: 0;
                                                  ">
                                                <a href="https://twitter.com/TheWritingRevol?lang=en" target="_blank">
                                                  <img width="24" height="24"
                                                    src="https://www.thewritingrevolution.org/img/email/v1/social_tw.png"
                                                    style="
                                                        float: left;
                                                        border: none;
                                                      " border="0" />
                                                </a>
                                              </td>
                                            </tr>
                                          </tbody>
                                        </table>
                                      </td>
                                    </tr>
                                  </tbody>
                                </table>
                              </td>
                            </tr>
                            <tr>
                              <td id="disclaimerText" class="js-disclaimer"
                                style="line-height: 1.2; color-scheme: light; color: rgb(33, 33, 33); font-family: Arial; font-size: 12px;padding-top: 24px">
                                {{disclaimer}}
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <table cellpadding="0" cellspacing="0" border="0" style="max-width: 600px; width: 100%">
                  <tbody>
                    <tr>
                      <td style="line-height: 0"></td>
                    </tr>
                  </tbody>
                </table>
              </td>
            </tr>
          </tbody>
        </table>
        <div class="preview__existing-signature" :class="existingSigLoaded">
          <div class="preview__heading">Previous Signature</div>
          <div class="existing-signature__html" v-html="existingSig"></div>
        </div>
      </div>
      <div class="copy__controls mt-2">
        <button @click="handleCopyToClipboard" id="ctc-btn" class="btn btn-copy btn-primary m-4">Copy to
          clipboard</button>
        <button @click="handleShare" id="share-btn" class="btn btn-share btn-primary m-4">Share</button>
        <br>
        <button @click="handleUpdateGmailSig" id="atg-btn" class="btn btn-secondary m-4" style="display: none;">Add to
          Gmail</button>
        <button @click="openInGmail" id="oig-btn" class="btn btn-secondary m-4" style="display: none;">Open
          Gmail <svg class="icon-external-link" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"
            style="fill: #fff">
            <!--! Font Awesome Pro 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
            <path
              d="M384 320c-17.67 0-32 14.33-32 32v96H64V160h96c17.67 0 32-14.32 32-32s-14.33-32-32-32L64 96c-35.35 0-64 28.65-64 64V448c0 35.34 28.65 64 64 64h288c35.35 0 64-28.66 64-64v-96C416 334.3 401.7 320 384 320zM488 0H352c-12.94 0-24.62 7.797-29.56 19.75c-4.969 11.97-2.219 25.72 6.938 34.88L370.8 96L169.4 297.4c-12.5 12.5-12.5 32.75 0 45.25C175.6 348.9 183.8 352 192 352s16.38-3.125 22.62-9.375L416 141.3l41.38 41.38c9.156 9.141 22.88 11.84 34.88 6.938C504.2 184.6 512 172.9 512 160V24C512 10.74 501.3 0 488 0z" />
          </svg></button>
      </div>
    </main>
    <footer class="footer mt-auto py-3 bg-dark">
      <div class="container text-center">
        <span class="text-muted">Â© 2009 - 2021 Kirk Clarke</span>
      </div>
    </footer>
  </div>

  <script>
    // TODO Make Vue code run before GAPI
    // TODO Provide feed back in case GAPI doesn't connect whenever
    // var tokenClient;
    // var access_token;

    // https://stackoverflow.com/a/38552302/3623472
    // also see -> https://googleonetap.developer.li/assets/js/utils.js and https://stackoverflow.com/a/47574303/4064162
    // consider using JWT decoder

    let atgBtn, oigBtn = {};

    function parseJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    };

    function handleCredentialResponse(response) {
      // console.log(response)
      const responsePayload = window.identity = parseJwt(response.credential);

      // TODO: need to validate --> https://developers.google.com/identity/gsi/web/guides/verify-google-id-token
      if (responsePayload.email_verified) {
        window.isAuthenticated = true;
        handleAuth();
      }
    }

    // retrieve previously created signature (if possible) and update email based on account chosen
    function getGmailSignature() {
      GAPI_ACTION = 'load';
      gapi.client.gmail.users.settings.sendAs.get({ "userId": window.identity.email, "sendAsEmail": window.identity.email })
        // gapi.client.gmail.users.settings.sendAs.list({ "userId": window.identity.email })
        .then(function (response) {
          root.existingSig = response.result.signature;
          root.email = response.result.sendAsEmail;
          setTimeout(() => {
            atgBtn.classList.remove('btn-success');
            atgBtn.innerText = root.atgBtnText;
          }, 2000);
        }, function (err) { console.error("Execute error", err); });
    }

    function showOpenInGmailBtn() {
      const openInGmailBtn = document.getElementById('oig-btn');
      openInGmailBtn.style.setProperty('display', 'inline-block');
    }

    function patchGmailSendAs() {
      GAPI_ACTION = 'set';
      const currentEmailSig = document.querySelector('.main__html').outerHTML;
      return gapi.client.gmail.users.settings.sendAs.patch({
        "userId": window.identity.email,
        "sendAsEmail": window.identity.email,
        "resource": {
          "signature": currentEmailSig
        }
      })
        .then(function (response) {
          // handle UI for atg-btn
          atgBtn.classList.remove('btn-info');
          atgBtn.classList.add('btn-success');
          atgBtn.innerText = "Added!";
          showOpenInGmailBtn();
          // update previous signature in preview
          getGmailSignature();
        },
          function (err) { console.error("Execute error", err); });
    }

    function getProfileDetails() {
      return gapi.client.people.people.get({
        "resourceName": "people/me",
        "personFields": "emailAddresses,names,genders,phoneNumbers,organizations"
      })
        .then(function (response) {
          const resp = response.result;
          if (resp.names) {
            const primaryName = findPrimary(resp.names, 'primary', true);
            root.personName = primaryName.displayName;
          }

          if (resp.genders) {

          } else {
            root.disablePronouns = true;
          }

          if (resp.phoneNumbers) {

          }
        },
          function (err) { console.error("Execute error", err); });
    }

    function findPrimary(arr, prop, val) {
      return arr.find(item => item.metadata[prop] === val);
    }

    function getGAPIAccessToken() {
      gapi.client.init({})
    }

    function handleAuth() {
      const authUserTxt = document.getElementById('gacct-user');
      if (window.isAuthenticated) {
        console.log("Authenticated!")
        window.signInWithBtn.style.setProperty('display', 'none');
        window.signOutBtn.style.setProperty('display', 'block');

        window.signOutBtn.innerHTML = `${window.identity
          .email} (Sign Out) <img class="gacct-user-avatar" src="${window.identity.picture}" alt="${window.identity
            .email}">`;
        authUserTxt.innerHTML = `Hey ${window.identity
          .given_name}!`;
        root.handleUpdateGmailSig();
      } else {
        console.log("Not Authenticated!")
        window.signInWithBtn.style.setProperty('display', 'block');
        window.signOutBtn.style.setProperty('display', 'none');
        authUserTxt.innerText = "";
        root.existingSig = '';
      }
      root.handleGAPIBtn();
    }

    function handleSignout() {
      google.accounts.id.disableAutoSelect();
      window.isAuthenticated = false;
      handleAuth()
    }

    const defaultData = {
      personName: "Full Name",
      pronouns: [{ id: 0, text: "pronoun" }],
      pronounIdIncrement: 0,
      disablePronouns: false,
      jobTitle: "Job title",
      orgName: "The Writing Revolution",
      orgLogo:
        "https://www.thewritingrevolution.org/img/twr-logo_color_250x72.png",
      mainPhoneNum: "+1 999.999.9999",
      website: "https://thewritingrevolution.org",
      email: "email@thewritingrevolution.org",
      addrLine1: "90 Broad Street",
      addrLine2: "3rd Floor",
      city: "New York",
      state: "NY",
      zip: "10004",
      existingSig: "",
      modelIsOpen: false,
      shareURL: "",
      atgBtnText: "Add to Gmail",
      dTxtItem: 'btn-disclaimer-none',
      disclaimer: "",
      legalDisclaimerText: `The information transmitted is intended only for the person or 
      entity to which it is addressed and may contain confidential and/or privileged material. 
      Any review, retransmission, dissemination, or other use of, or taking of any action in reliance upon, 
      this information by persons or entities other than the intended recipient is prohibited. 
      If you received this in error, please contact the sender and delete the material from any computer. 
      This message cannot be guaranteed to be secure or error-free. We reserve the right to monitor 
      and review the content of all email communications sent or received. Emails sent to or from 
      this address may be stored in accordance with regulatory requirements.`,
      responseTimeDisclaimerText: `Due to an increased number of support requests we are currently receiving, 
      it may take up to X days to receive a response. We always respond to licensed users first. 
      We apologize for the inconvenience.`
    };
    // const genderPronouns = [
    //   "co",
    //   "e",
    //   "eir",
    //   "em",
    //   "es",
    //   "ey",
    //   "fae",
    //   "he",
    //   "her",
    //   "him",
    //   "hir",
    //   "hirs",
    //   "hu",
    //   "mx",
    //   "she",
    //   "sie",
    //   "tem",
    //   "ter",
    //   "tey",
    //   "their",
    //   "them",
    //   "they",
    //   "xe",
    //   "xem",
    //   "xyr",
    //   "ze",
    //   "zie",
    //   "zir",
    //   "zirs",
    // ];

    const app = Vue.createApp({
      data() {
        return defaultData
      },
      methods: {
        handleGAPIBtn() {
          atgBtn = document.getElementById('atg-btn');
          oigBtn = document.getElementById('oig-btn');

          if (window.isAuthenticated) {
            atgBtn.style.setProperty('display', 'inline-block');
          } else {
            atgBtn.style.setProperty('display', 'none');
            oigBtn.style.setProperty('display', 'none');
          }
        },
        handleFocus(event, val) {
          event.target.select();
        },
        openInGmail() {
          let newTab = window.open();
          //detailed gmail url structure: https://stackoverflow.com/a/70030094/3623472
          newTab.location.href = `https://mail.google.com/mail/u/${window.identity.email}#compose?compose=new`;
        },
        detectMobile() {
          let isMobile = false;
          const isScreenMobile = window.matchMedia("only screen and (max-width: 760px)");
          if (/Mobi|Tablet|iPad|iPhone/i.test(navigator.userAgent) || isScreenMobile.matches) {
            isMobile = true
          }
          return isMobile;
        },
        buildShareParam(key) {
          return encodeURI(`${key}=${root[key]}`);
        },
        handleShare(event) {
          let query = '';
          let queryParams = new URLSearchParams(window.location.search);
          const shareFields = ["personName", "pronouns", "jobTitle", "mainPhoneNum", "website", "email", "dTxtItem", "disclaimer"];

          shareFields.forEach((field, index) => {
            let queryParam = [];
            if (field === "pronouns") {
              // get pronouns and map values
              // TODO setup pronouns to handle spaces properly
              let pronounsVal = this.getPronouns("")
                .replace("&nbsp;", "")
                .replace(/[\(\)]/g, "")
                .trim()
                .replaceAll(/\s/g, "%20");

              query = `${query}&${field}=${pronounsVal}`;
              queryParam.push(field);
              queryParam.push(pronounsVal)
            } else {
              queryParam = this.buildShareParam(field).split("=")
              query = query + (index === 0 ? "?" : "&") + this.buildShareParam(field);
            }
            queryParams.append(queryParam[0], queryParam[1]);
          });
          // concat the URL origin + pathname + querystring and then trigger a popup passing the share url
          this.handleModal(windowUrl.origin + windowUrl.pathname + query);
        },
        handleModal(urlString) {
          this.triggerModal();
          this.shareURL = urlString;
        },
        handleQuery(params) {
          // check and set field values based on params
          for (let filterArr of params.entries()) {
            const searchEntryName = filterArr[0];
            const searchEntryValue = filterArr[1];
            if (Object.hasOwn(this, searchEntryName)) {
              if (searchEntryName == "dTxtItem") {
                const selectedDisclaimerbtn = document.getElementById(searchEntryValue)
                selectedDisclaimerbtn.checked = true;
              }

              if (searchEntryName === "pronouns") {
                // disable pronouns if none are found
                if (searchEntryValue == "") {
                  this.disablePronouns = true;
                } else {
                  // create array for pronouns
                  const pronounsArr = searchEntryValue.split(" ");
                  const updatedPronouns = [];
                  pronounsArr.forEach(function (pronounVal, index) {
                    updatedPronouns.push({ id: index, text: pronounVal })
                  })
                  // update pronouns in v-model
                  this.pronouns = updatedPronouns;
                }
              } else {
                if (this[searchEntryName] !== searchEntryValue) {
                  // add back the plus for country code if we're dealing with mainPhoneNum --> this could be better
                  this[searchEntryName] = (this[searchEntryName] === this.mainPhoneNum ? "+" : "") + searchEntryValue;
                }
              }
            }
          }
        },
        handleCopyToClipboard(event) {
          if (this.detectMobile || navigator.clipboard) {
            this.getHTMLSignature(event);
          } else {
            // add event listener copy then trigger copy event
            document.addEventListener('copy', this.getHTMLSignature)
            document.execCommand('copy');
          }
        },
        handleUpdateGmailSig() {
          if (event.target.id == "atg-btn") {
            GAPI_ACTION = 'set';
            setTimeout(() => {
              atgBtn.classList.add('btn-info');
              atgBtn.innerHTML = 'Updating...';
            }, 10);
          }
          gapi.load('client', getGAPIAccessToken)
          // console.log(window.client)
          // if (gapi.client.getToken() === null) {
          //   // Prompt the user to select an Google Account and asked for consent to share their data
          //   // when establishing a new session.
          //   tokenClient.requestAccessToken({ prompt: 'consent' });
          // } else {
          //   // Skip display of account chooser and consent dialog for an existing session.
          //   tokenClient.requestAccessToken({ prompt: '' });
          // }
          window.client.requestAccessToken();
        },
        getHTMLSignature(e) {
          // needed to prevent browser from overriding clipboard
          e.preventDefault();
          // need HTML and Plain text as fallback (Chrome Android 97.0.4692.98)
          const htmlData = document.querySelector('.main__html').outerHTML;
          const plainData = document.querySelector('.app__preview').innerText;
          // setup newer clipboard async https://www.nikouusitalo.com/blog/why-isnt-clipboard-write-copying-my-richtext-html/
          if (e.target.id === 'ctc-btn') {
            const clipboardItem = new ClipboardItem({
              "text/plain": new Blob(
                [plainData],
                { type: "text/plain" }
              ),
              "text/html": new Blob(
                [htmlData],
                { type: "text/html" }
              ),
            });
            navigator.clipboard.write([clipboardItem]);
          } else {
            const clipboardData = e.clipboardData || window.clipboardData || e.originalEvent.clipboardData;
            clipboardData.setData('text/plain', plainData);
            clipboardData.setData('text/html', htmlData);
            document.removeEventListener('copy', this.getHTMLSignature);
          }
          this.handleCopyToClipboardBtn('ctc-btn');
        },
        getShareURL(e) {
          e.preventDefault();
          const shareLink = this.shareURL;
          const clipboardItem = new ClipboardItem({
            "text/plain": new Blob(
              [shareLink],
              { type: "text/plain" }
            ),
            "text/html": new Blob(
              [shareLink],
              { type: "text/html" }
            ),
          });
          navigator.clipboard.write([clipboardItem]);
          this.handleCopyToClipboardBtn('modal-ctc-btn');
        },
        handleCopyToClipboardBtn(elemID) {
          const copiedTxt = 'Copied!'
          const defaultBtn = document.getElementById(elemID);
          const defaultBtnText = defaultBtn.innerText;
          defaultBtn.innerText = copiedTxt;
          defaultBtn.classList.add('btn-success');
          setTimeout(() => {
            defaultBtn.innerText = defaultBtnText;
            defaultBtn.classList.remove('btn-success');
          }, 2000);
        },
        // toggle the given disclaimer text
        insertDisclaimer(e, txt) {
          const radioChecked = e.target.checked === true
          const disclaimerHasText = (radioChecked) ? true : false;

          this.dTxtItem = e.target.id;
          this.disclaimer = (disclaimerHasText) ? txt.replace(/\n\s+/g, '') : "";
        },
        // TODO: update pronouns to be predefined and togglable
        insertPronoun(index) {
          // add new pronoun and pronoun increment id
          let increment = this.pronounIdIncrement + 1;
          this.pronouns.splice(index + 1, 0, {
            id: increment,
            text: "pronoun",
          });
          this.pronounIdIncrement = increment;
        },
        removePronoun(id) {
          // get matching pronoun id and find index of object in pronoun array

          const i = this.pronouns.findIndex((pronoun) => {
            return pronoun.id == id;
          });
          // if found, remove it
          if (i > -1) {
            this.pronouns.splice(i, 1);
          }
        },
        // get pronoun values and join by given separator
        getPronouns(separator) {
          const args = this.pronouns;

          // hide pronouns are checked
          if (this.disablePronouns) {
            return "";
          }

          // handle if no pronouns are provided
          if (args.length == 1 && args[0].text == "") {
            return "";
          }
          if (args.every((item) => item.text == "")) {
            return "";
          }

          return `${this.hasName ? "&nbsp;" : ""}(${args
            .map((str) => {
              // index needed due to proxy from spread
              return str.text.toLowerCase();
              // console.log(str[index].text.toLowerCase());
            })
            .join(separator + " ")}) `;
        },
        // onload check/manage filters
        checkSearchParams(url, useHistory = false) {
          let searchParams = url.searchParams;
          if ([...searchParams].length > 0) {
            this.handleQuery(searchParams)
          }
        },
        formatPhone(countryCode = "+1", phoneFormat = "$1.$2.$3") {
          // TODO: find ways to improve this 
          let cleanNum = "";
          let validNum = "";
          let mainNum = "";
          if (this.mainPhoneNum.startsWith("+")) {
            cleanNum = this.mainPhoneNum.replace("+", "").slice();
          }

          cleanNum = this.mainPhoneNum.replace(/\D+/g, '');
          let TenDigitsReversed = [...cleanNum].reverse().join('').substr(0, 10);
          cleanNum = validNum = [...TenDigitsReversed].reverse().join("");


          if (this.mainPhoneNum.length < countryCode.length + 3 + cleanNum.length) {
            mainNum = cleanNum.replace(/(\d{3})(\d{3})(\d{4})/, countryCode + " " + phoneFormat);
            validNum = mainNum;
          }
          this.mainPhoneNum = validNum;
        },
        triggerModal() {
          return this.modelIsOpen = !this.modelIsOpen;
        }
      },
      computed: {
        existingSigLoaded() {
          return {
            'is--loaded': this.existingSig.length != 0,
          }
        },
        hasWebsite() {
          return this.website.length != 0;
        },
        getWebsiteHost() {
          return this.website.split('//')[1];
        },
        hasName() {
          return this.personName.length != 0;
        },
        hasPronouns() {
          const containsPronoun = this.pronouns.some(
            (item) => item.text.length != 0
          );
          return this.pronouns.length > 0 && containsPronoun;
        }
      },
      async mounted() {
        if (windowUrl.search !== "") {
          this.checkSearchParams(windowUrl);
        }
      }
    })

    const root = app.mount("#app");

  </script>
  <script async defer src="https://apis.google.com/js/api.js">
  </script>
</body>

</html>